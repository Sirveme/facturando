{% extends "base.html" %}

{% block title %}Comprobantes - facturalo.pro{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/dashboard.css') }}?v=4">
<link rel="stylesheet" href="{{ url_for('static', path='/css/comprobantes.css') }}?v=4">
{% endblock %}

{% block body %}
<div class="dashboard-layout">
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="menu-toggle" id="menu-toggle" aria-label="Toggle menu">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            
            <a href="/dashboard" class="header-logo">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <rect width="32" height="32" rx="8" fill="url(#logo-gradient)"/>
                    <path d="M16 8L20 16H12L16 24" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <defs>
                        <linearGradient id="logo-gradient" x1="0" y1="0" x2="32" y2="32">
                            <stop offset="0%" style="stop-color:#d4af37"/>
                            <stop offset="100%" style="stop-color:#b8860b"/>
                        </linearGradient>
                    </defs>
                </svg>
                <span>facturalo.pro</span>
            </a>
        </div>
        
        <div class="header-right">
            <button class="theme-toggle" id="theme-toggle" aria-label="Cambiar tema">
                <svg class="icon-sun" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                </svg>
                <svg class="icon-moon" width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                </svg>
            </button>
            
            <div class="header-user">
                <div class="avatar">
                    <span>{{ user_ruc[:2] if user_ruc else '??' }}</span>
                </div>
                <div class="header-user-info">
                    <div class="header-user-name">{{ emisor.razon_social[:20] if emisor and emisor.razon_social else 'Usuario' }}{% if emisor and emisor.razon_social and emisor.razon_social|length > 20 %}...{% endif %}</div>
                    <div class="header-user-role">RUC {{ user_ruc if user_ruc else '' }}</div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <nav class="sidebar-nav">
            <div class="sidebar-section">
                <a href="/dashboard" class="sidebar-link {% if request.url.path == '/dashboard' %}active{% endif %}">
                    <span class="sidebar-link-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="/comprobantes" class="sidebar-link {% if '/comprobantes' in request.url.path and 'emitir' not in request.url.path and 'nota' not in request.url.path %}active{% endif %}">
                    <span class="sidebar-link-icon">üìÑ</span>
                    <span>Comprobantes</span>
                </a>
                <a href="/comprobantes/emitir" class="sidebar-link {% if request.url.path == '/comprobantes/emitir' %}active{% endif %}">
                    <span class="sidebar-link-icon">‚ûï</span>
                    <span>Emitir</span>
                </a>
                <a href="/productos" class="sidebar-link {% if '/productos' in request.url.path %}active{% endif %}">
                    <span class="sidebar-link-icon">üì¶</span>
                    <span>Productos</span>
                </a>
                <a href="/clientes" class="sidebar-link {% if '/clientes' in request.url.path %}active{% endif %}">
                    <span class="sidebar-link-icon">üë•</span>
                    <span>Clientes</span>
                </a>
                <a href="/reportes" class="sidebar-link {% if '/reportes' in request.url.path %}active{% endif %}">
                    <span class="sidebar-link-icon">üìà</span>
                    <span>Reportes</span>
                </a>
                <a href="/configuracion" class="sidebar-link {% if '/configuracion' in request.url.path %}active{% endif %}">
                    <span class="sidebar-link-icon">‚öôÔ∏è</span>
                    <span>Configuraci√≥n</span>
                </a>
            </div>
            <div class="sidebar-section" style="margin-top: auto; border-top: 1px solid var(--border-color); padding-top: var(--space-4);">
                <a href="/logout" class="sidebar-link">
                    <span class="sidebar-link-icon">üö™</span>
                    <span>Cerrar Sesi√≥n</span>
                </a>
            </div>
        </nav>
    </aside>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
    
    <!-- Main Content -->
    <!-- Main Content -->
    <main class="main">
        <div class="page-header">
            <div>
                <h1 class="page-title">Comprobantes Electr√≥nicos</h1>
                <p class="page-description">{{ total }} comprobantes emitidos ({{ total_hoy }} hoy)</p>
            </div>
            <div class="flex gap-3">
                <button class="btn btn-ghost" id="btn-abrir-filtros">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                    </svg>
                    Filtros
                </button>
                <a href="/comprobantes/emitir" class="btn btn-primary">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Emitir Comprobante
                </a>
            </div>
        </div>

        <!-- AGREGAR despu√©s de <div class="page-header"> y ANTES de la tabla -->

        {% if total_rechazados > 0 %}
        <div class="alert alert-warning" style="margin-bottom: 2rem;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <svg width="32" height="32" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                <div style="flex: 1;">
                    <strong style="font-size: 1.125rem;">{{ total_rechazados }} comprobantes rechazados hoy</strong>
                    <p style="margin: 0.25rem 0 0; color: var(--text-secondary);">SUNAT no acept√≥ estos comprobantes. Puedes reenviarlos ahora.</p>
                </div>
                <button class="btn btn-primary" onclick="reenviarTodosRechazados()" id="btn-reenviar-todos">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Reenviar Todos
                </button>
            </div>
        </div>
        {% endif %}
        
        <!-- Tabla de Comprobantes -->
        <div class="card">
            <div class="table-container">
                {% if comprobantes %}
                <table class="table table-dense">
                    <thead>
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 20%;">Comprobante</th>
                            <th style="width: 30%;">Cliente</th>
                            <th style="width: 15%;" class="text-right">Monto</th>
                            <th style="width: 15%;">Estado</th>
                            <th style="width: 15%;"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comp in comprobantes %}
                        <tr class="table-row-main" data-comprobante-id="{{ comp.id }}" data-estado="{{ comp.estado }}">
                            <td>
                                <div class="row-number">
                                    {{ ((page - 1) * per_page) + loop.index }}
                                </div>
                            </td>
                            <td>
                                <div class="comprobante-cell">
                                    <span class="comprobante-serie">{{ comp.serie }}-{{ "%08d"|format(comp.numero) }}</span>
                                    <span class="comprobante-date">{{ comp.fecha_emision.strftime('%d %b, %Y') }}</span>
                                </div>
                            </td>
                            <td>
                                <div class="cliente-cell">
                                    <span class="cliente-nombre">{{ comp.cliente_razon_social or 'Sin cliente' }}</span>
                                    <span class="cliente-doc">{{ comp.cliente_numero_documento or '-' }}</span>
                                </div>
                            </td>
                            <td class="text-right">
                                <div class="monto-cell">
                                    <span class="monto-total">S/ {{ "%.2f"|format(comp.monto_total) }}</span>
                                    <span class="monto-detalle">Base: S/ {{ "%.2f"|format(comp.monto_base) }}</span>
                                </div>
                            </td>
                            <td>
                                {% if comp.estado == 'aceptado' %}
                                <span class="badge badge-success">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    Aceptado
                                </span>
                                {% elif comp.estado == 'rechazado' %}
                                <span class="badge badge-danger">
                                    <svg width="12" height="12" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                    </svg>
                                    Rechazado
                                </span>
                                {% elif comp.estado == 'enviando' %}
                                <span class="badge badge-warning">
                                    <svg width="12" height="12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                    </svg>
                                    Enviando
                                </span>
                                {% else %}
                                <span class="badge badge-{{ comp.estado }}" data-estado="{{ comp.estado }}">
                                {% endif %}
                            </td>
                            <td>
                                <div class="table-actions">
                                    <button class="btn-icon" title="Ver comprobante" onclick="verComprobante('{{ comp.id }}')">
                                        üëÅÔ∏è
                                    </button>    

                                    <a href="/api/comprobantes/{{ comp.id }}/xml" class="btn-icon-sm" title="Descargar XML" download>
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                        </svg>
                                    </a>
                                    <a href="/api/comprobantes/{{ comp.id }}/pdf" class="btn-icon-sm" title="Descargar PDF" target="_blank">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                                        </svg>
                                    </a>
                                    {% if comp.estado == 'rechazado' %}
                                    <button class="btn-icon-sm" title="Reenviar" onclick="reenviar('{{ comp.id }}')">
                                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                        </svg>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <h3>No hay comprobantes</h3>
                    <p>{% if estado %}No se encontraron comprobantes con estado "{{ estado }}"{% else %}Emite tu primer comprobante electr√≥nico{% endif %}</p>
                    <a href="/comprobantes/emitir" class="btn btn-primary">Emitir ahora</a>
                </div>
                {% endif %}
            </div>
            
            <!-- Paginaci√≥n -->
            {% if total_pages > 1 %}
            <div class="card-footer">
                <div class="pagination">
                    {% if page > 1 %}
                    <a href="/comprobantes?page={{ page - 1 }}{% if estado %}&estado={{ estado }}{% endif %}{% if buscar %}&buscar={{ buscar }}{% endif %}" class="btn btn-ghost btn-sm">Anterior</a>
                    {% endif %}
                    
                    <span class="pagination-info">
                        Mostrando {{ inicio }} - {{ fin }} de {{ total }} comprobantes
                    </span>
                    
                    {% if page < total_pages %}
                    <a href="/comprobantes?page={{ page + 1 }}{% if estado %}&estado={{ estado }}{% endif %}{% if buscar %}&buscar={{ buscar }}{% endif %}" class="btn btn-ghost btn-sm">Siguiente</a>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </main>
    
    <!-- BOTONERA FIJA -->
    <div class="bottom-nav">
        <div class="bottom-nav-content">
            <a href="/comprobantes/emitir" class="bottom-nav-btn primary">
                <div class="bottom-nav-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </div>
                <span class="bottom-nav-label">Emitir</span>
            </a>
            
            <a href="/comprobantes?estado=aceptado" class="bottom-nav-btn {% if estado == 'aceptado' %}active{% endif %}">
                <div class="bottom-nav-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <span class="bottom-nav-label">Aceptados</span>
            </a>
            
            <a href="/comprobantes?estado=encolado" class="bottom-nav-btn {% if estado == 'encolado' %}active{% endif %}">
                <div class="bottom-nav-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    {% if total_encolados > 0 %}
                    <span class="bottom-nav-badge">{{ total_encolados }}</span>
                    {% endif %}
                </div>
                <span class="bottom-nav-label">En cola</span>
            </a>
            
            <a href="/comprobantes?estado=rechazado" class="bottom-nav-btn {% if estado == 'rechazado' %}active{% endif %}">
                <div class="bottom-nav-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    {% if total_rechazados > 0 %}
                    <span class="bottom-nav-badge">{{ total_rechazados }}</span>
                    {% endif %}
                </div>
                <span class="bottom-nav-label">Rechazados</span>
            </a>
            
            <a href="/comprobantes" class="bottom-nav-btn {% if not estado %}active{% endif %}">
                <div class="bottom-nav-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                    </svg>
                </div>
                <span class="bottom-nav-label">Todos</span>
            </a>
        </div>
    </div>

    <!-- AGREGAR antes del cierre de </div> (dashboard-layout) -->
    <!-- Modal de Progreso -->
    <div class="modal" id="modal-progreso">
        <div class="modal-backdrop"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Reenviando a SUNAT</h3>
            </div>
            <div class="modal-body">
                <div style="text-align: center; padding: 2rem 0;">
                    <!-- Spinner -->
                    <div style="width: 80px; height: 80px; margin: 0 auto 2rem; border: 4px solid var(--bg-tertiary); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    
                    <!-- Texto principal -->
                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--text-primary); margin-bottom: 0.5rem;" id="progreso-texto">
                        Procesando...
                    </div>
                    
                    <!-- Subtexto -->
                    <div style="color: var(--text-secondary); margin-bottom: 2rem;" id="progreso-subtexto">
                        Iniciando reenv√≠o
                    </div>
                    
                    <!-- Barra de progreso -->
                    <div style="background: var(--bg-tertiary); height: 8px; border-radius: 999px; overflow: hidden; margin-bottom: 1rem;">
                        <div id="progreso-barra" style="background: var(--primary); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    
                    <!-- Contador -->
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">
                        <span id="progreso-contador">0 / 0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    </style>

</div>

<!-- MODAL FILTROS -->
<div class="modal" id="modal-filtros">
    <div class="modal-backdrop" id="modal-filtros-backdrop"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Filtrar Comprobantes</h3>
            <button class="modal-close" id="btn-cerrar-filtros">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form method="GET" action="/comprobantes" class="modal-body">
            <div class="input-group">
                <label class="input-label" for="buscar">Buscar</label>
                <input 
                    type="text" 
                    id="buscar" 
                    name="buscar" 
                    class="input" 
                    placeholder="Serie o n√∫mero..."
                    value="{{ buscar or '' }}"
                >
            </div>
            
            <div class="input-group">
                <label class="input-label" for="estado">Estado</label>
                <select id="estado" name="estado" class="input">
                    <option value="">Todos</option>
                    <option value="aceptado" {% if estado == 'aceptado' %}selected{% endif %}>Aceptado</option>
                    <option value="rechazado" {% if estado == 'rechazado' %}selected{% endif %}>Rechazado</option>
                    <option value="encolado" {% if estado == 'encolado' %}selected{% endif %}>En cola</option>
                    <option value="enviando" {% if estado == 'enviando' %}selected{% endif %}>Enviando</option>
                </select>
            </div>
            
            <div class="form-row">
                <div class="input-group">
                    <label class="input-label" for="fecha_desde">Desde</label>
                    <input 
                        type="date" 
                        id="fecha_desde" 
                        name="fecha_desde" 
                        class="input"
                        value="{{ fecha_desde or '' }}"
                    >
                </div>
                
                <div class="input-group">
                    <label class="input-label" for="fecha_hasta">Hasta</label>
                    <input 
                        type="date" 
                        id="fecha_hasta" 
                        name="fecha_hasta" 
                        class="input"
                        value="{{ fecha_hasta or '' }}"
                    >
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-ghost" id="btn-limpiar-filtros">Limpiar</button>
                <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Ver Comprobante -->
<div class="modal-overlay" id="modal-ver">
    <div class="modal modal-lg">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-ver-titulo">Comprobante</h3>
            <button class="modal-close" onclick="cerrarModalVer()">&times;</button>
        </div>
        <div class="modal-body" id="modal-ver-contenido">
            <div class="loading">Cargando...</div>
        </div>
        <div class="modal-footer">
            <a href="#" id="btn-descargar-pdf" class="btn btn-primary">üìÑ Descargar PDF</a>
            <a href="#" id="btn-descargar-xml" class="btn btn-ghost">üìã Descargar XML</a>
            <button class="btn btn-ghost" onclick="cerrarModalVer()">Cerrar</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}

<script>

// Variables globales para tracking
let progresoInterval = null;
let progresoInicio = null;
let totalOriginal = 0;

// Modal filtros
document.getElementById('btn-abrir-filtros').addEventListener('click', () => {
    document.getElementById('modal-filtros').classList.add('active');
    document.body.style.overflow = 'hidden';
});

document.getElementById('btn-cerrar-filtros').addEventListener('click', () => {
    document.getElementById('modal-filtros').classList.remove('active');
    document.body.style.overflow = '';
});

document.getElementById('modal-filtros-backdrop').addEventListener('click', () => {
    document.getElementById('modal-filtros').classList.remove('active');
    document.body.style.overflow = '';
});

document.getElementById('btn-limpiar-filtros').addEventListener('click', () => {
    window.location.href = '/comprobantes';
});

// Reenviar
// Reenviar comprobante individual (en el mismo script)
async function reenviar(comprobanteId) {
    const confirmado = await confirmModal(
        '¬øReenviar este comprobante?',
        'Se volver√° a enviar a SUNAT para su validaci√≥n.',
        'Reenviar',
        'Cancelar'
    );
    
    if (!confirmado) return;
    
    const toastId = toast.loading('Reenviando comprobante...');
    
    try {
        const response = await fetch(`/api/comprobantes/${comprobanteId}/reenviar`, {
            method: 'POST'
        });
        
        const data = await response.json();
        
        toast.remove(toastId);
        
        if (response.ok) {
            toast.success(data.mensaje || 'Comprobante reenviado');
            setTimeout(() => location.reload(), 1500);
        } else {
            toast.error('Error al reenviar', data.mensaje);
        }
    } catch (error) {
        toast.remove(toastId);
        toast.error('Error de conexi√≥n', error.message);
    }
}

// AGREGAR esta funci√≥n al final del <script> existente

// Reenviar todos los rechazados
// Reenviar todos los rechazados (SIN alert, SIN confirm)
// Reenviar todos los rechazados CON PROGRESO
async function reenviarTodosRechazados() {
    const btn = document.getElementById('btn-reenviar-todos');
    
    const confirmado = await confirmModal(
        '¬øReenviar todos los rechazados?',
        `Se reenviar√°n {{ total_rechazados }} comprobantes a SUNAT. Podr√°s ver el progreso en tiempo real.`,
        'S√≠, reenviar',
        'Cancelar'
    );
    
    if (!confirmado) return;
    
    btn.disabled = true;
    btn.classList.add('loading');
    
    try {
        const response = await fetch('/api/comprobantes/reenviar-rechazados', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                emisor_ruc: '{{ user_ruc }}'
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.exito) {
            if (data.total === 0) {
                toast.info('Sin comprobantes para reenviar', data.mensaje);
                btn.disabled = false;
                btn.classList.remove('loading');
                return;
            }
            
            // Mostrar modal de progreso
            totalOriginal = data.total;
            progresoInicio = Date.now();
            
            mostrarModalProgreso();
            iniciarMonitoreoProgreso();
            
        } else {
            toast.error('Error al reenviar', data.mensaje || 'Error desconocido');
            btn.disabled = false;
            btn.classList.remove('loading');
        }
    } catch (error) {
        toast.error('Error de conexi√≥n', error.message);
        btn.disabled = false;
        btn.classList.remove('loading');
    }
}

// Mostrar modal de progreso
function mostrarModalProgreso() {
    const modal = document.getElementById('modal-progreso');
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
}

// Cerrar modal de progreso
function cerrarModalProgreso() {
    const modal = document.getElementById('modal-progreso');
    modal.classList.remove('active');
    document.body.style.overflow = '';
    
    if (progresoInterval) {
        clearInterval(progresoInterval);
        progresoInterval = null;
    }
}

// Monitorear progreso
function iniciarMonitoreoProgreso() {
    let intentos = 0;
    const maxIntentos = 60; // 60 segundos m√°ximo
    
    progresoInterval = setInterval(async () => {
        intentos++;
        
        try {
            const response = await fetch('/api/comprobantes/progreso-reenvio/{{ user_ruc }}');
            const data = await response.json();
            
            // Actualizar UI
            const completados = data.recien_aceptados;
            const procesando = data.procesando;
            const rechazados = data.rechazados;
            const total = completados + procesando + rechazados;
            
            const porcentaje = data.progreso_porcentaje;
            
            // Actualizar elementos
            document.getElementById('progreso-barra').style.width = `${porcentaje}%`;
            document.getElementById('progreso-contador').textContent = `${completados} / ${total}`;
            
            if (procesando > 0) {
                const tiempoTranscurrido = Math.floor((Date.now() - progresoInicio) / 1000);
                document.getElementById('progreso-texto').textContent = `Procesando ${procesando} comprobantes`;
                document.getElementById('progreso-subtexto').textContent = `${completados} completados ‚Ä¢ ${tiempoTranscurrido}s transcurridos`;
            } else if (rechazados > 0 && completados > 0) {
                document.getElementById('progreso-texto').textContent = `‚úì ${completados} aceptados`;
                document.getElementById('progreso-subtexto').textContent = `${rechazados} a√∫n rechazados`;
            } else if (rechazados === 0 && completados > 0) {
                // TODOS COMPLETADOS
                document.getElementById('progreso-texto').textContent = `‚úì Completado`;
                document.getElementById('progreso-subtexto').textContent = `${completados} comprobantes aceptados por SUNAT`;
                
                setTimeout(() => {
                    cerrarModalProgreso();
                    toast.success('Reenv√≠o completado', `${completados} comprobantes aceptados`);
                    setTimeout(() => location.reload(), 1500);
                }, 2000);
                
                clearInterval(progresoInterval);
            } else if (procesando === 0 && rechazados > 0 && completados === 0) {
                // TODOS RECHAZADOS
                document.getElementById('progreso-texto').textContent = `‚úó Finalizado con errores`;
                document.getElementById('progreso-subtexto').textContent = `${rechazados} comprobantes siguen rechazados`;
                
                setTimeout(() => {
                    cerrarModalProgreso();
                    toast.warning('Reenv√≠o finalizado', `${rechazados} comprobantes a√∫n tienen errores`);
                    setTimeout(() => location.reload(), 1500);
                }, 2000);
                
                clearInterval(progresoInterval);
            }
            
            // Timeout
            if (intentos >= maxIntentos) {
                cerrarModalProgreso();
                toast.warning('Tiempo agotado', 'Recarga la p√°gina para ver el estado actualizado');
                clearInterval(progresoInterval);
            }
            
        } catch (error) {
            console.error('Error obteniendo progreso:', error);
        }
        
    }, 1000); // Cada 1 segundo
}

// =============================================
// ACTUALIZACI√ìN AUTOM√ÅTICA DE ESTADOS
// =============================================
(function() {
    // Comprobantes en estado "enviando"
    let comprobantesEnviando = [];
    
    function detectarEnviando() {
        comprobantesEnviando = [];
        document.querySelectorAll('[data-estado="enviando"]').forEach(el => {
            const id = el.dataset.comprobanteId;
            if (id) comprobantesEnviando.push(id);
        });
        return comprobantesEnviando.length > 0;
    }
    
    async function verificarEstados() {
        if (comprobantesEnviando.length === 0) return;
        
        for (const id of comprobantesEnviando) {
            try {
                const response = await fetch(`/api/comprobantes/${id}`);
                const result = await response.json();
                
                if (result.exito && result.datos) {
                    const estado = result.datos.estado;
                    
                    // Si ya no est√° "enviando", actualizar UI
                    if (estado !== 'enviando') {
                        actualizarEstadoUI(id, estado, result.datos.error_mensaje);
                        
                        // Remover de la lista
                        comprobantesEnviando = comprobantesEnviando.filter(c => c !== id);
                        
                        // Mostrar toast
                        if (estado === 'aceptado') {
                            toast.success('¬°Comprobante aceptado!', 'SUNAT acept√≥ el comprobante');
                        } else if (estado === 'rechazado') {
                            toast.error('Comprobante rechazado', result.datos.error_mensaje || 'Error de SUNAT');
                        }
                    }
                }
            } catch (error) {
                console.error('Error verificando estado:', error);
            }
        }
    }
    
    function actualizarEstadoUI(id, estado, mensaje) {
        const fila = document.querySelector(`[data-comprobante-id="${id}"]`);
        if (!fila) return;
        
        const badge = fila.querySelector('.badge');
        if (badge) {
            // Actualizar clase y texto
            badge.className = 'badge';
            badge.classList.add(`badge-${estado}`);
            badge.textContent = estado.charAt(0).toUpperCase() + estado.slice(1);
            badge.dataset.estado = estado;
        }
        
        // Actualizar data-estado del contenedor
        fila.dataset.estado = estado;
    }
    
    // Iniciar polling si hay comprobantes enviando
    if (detectarEnviando()) {
        console.log('üì° Iniciando polling para', comprobantesEnviando.length, 'comprobantes');
        
        // Verificar cada 3 segundos
        const intervalo = setInterval(() => {
            if (comprobantesEnviando.length === 0) {
                console.log('‚úÖ Todos los comprobantes procesados');
                clearInterval(intervalo);
                return;
            }
            verificarEstados();
        }, 3000);
    }
})();

// =============================================
// MODAL VER COMPROBANTE
// =============================================
async function verComprobante(id) {
    const modal = document.getElementById('modal-ver');
    const contenido = document.getElementById('modal-ver-contenido');
    const titulo = document.getElementById('modal-ver-titulo');
    
    console.log('Modal antes:', modal.style.display);
    modal.classList.add('active');
    console.log('Modal despu√©s:', modal.style.display);

    contenido.innerHTML = '<div class="loading"><span class="spinner"></span> Cargando...</div>';
    
    try {
        const response = await fetch(`/api/comprobantes/${id}/detalle`);
        const result = await response.json();
        
        if (result.exito && result.datos) {
            const c = result.datos;
            
            titulo.textContent = `${c.tipo_documento_nombre} ${c.numero_formato}`;
            
            contenido.innerHTML = `
                <div class="comprobante-preview">
                    <div class="preview-header">
                        <div class="preview-emisor">
                            <h4>${c.emisor_razon_social}</h4>
                            <p>RUC: ${c.emisor_ruc}</p>
                            <p>${c.emisor_direccion || ''}</p>
                        </div>
                        <div class="preview-doc">
                            <div class="preview-doc-tipo">${c.tipo_documento_nombre}</div>
                            <div class="preview-doc-numero">${c.numero_formato}</div>
                        </div>
                    </div>
                    
                    <div class="preview-info">
                        <div class="preview-row">
                            <span class="label">Fecha de Emisi√≥n:</span>
                            <span>${c.fecha_emision}</span>
                        </div>
                        <div class="preview-row">
                            <span class="label">Cliente:</span>
                            <span>${c.cliente_razon_social || 'No especificado'}</span>
                        </div>
                        <div class="preview-row">
                            <span class="label">RUC/DNI:</span>
                            <span>${c.cliente_numero_documento || '-'}</span>
                        </div>
                        <div class="preview-row">
                            <span class="label">Direcci√≥n:</span>
                            <span>${c.cliente_direccion || '-'}</span>
                        </div>
                    </div>
                    
                    <table class="preview-items">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Descripci√≥n</th>
                                <th>Cant.</th>
                                <th>P. Unit.</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${c.items.map((item, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${item.descripcion}</td>
                                    <td>${item.cantidad}</td>
                                    <td>S/ ${parseFloat(item.precio_unitario).toFixed(2)}</td>
                                    <td>S/ ${parseFloat(item.monto_linea).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div class="preview-totales">
                        <div class="total-row">
                            <span>Op. Gravada:</span>
                            <span>S/ ${parseFloat(c.monto_base).toFixed(2)}</span>
                        </div>
                        <div class="total-row">
                            <span>IGV (18%):</span>
                            <span>S/ ${parseFloat(c.monto_igv).toFixed(2)}</span>
                        </div>
                        <div class="total-row total-final">
                            <span>TOTAL:</span>
                            <span>S/ ${parseFloat(c.monto_total).toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="preview-estado">
                        <span class="badge badge-${c.estado}">${c.estado.toUpperCase()}</span>
                        ${c.respuesta_sunat ? `<p class="text-secondary">${c.respuesta_sunat}</p>` : ''}
                    </div>
                </div>
            `;
            
            // Actualizar links de descarga
            document.getElementById('btn-descargar-pdf').href = `/api/comprobantes/${id}/pdf`;
            document.getElementById('btn-descargar-xml').href = `/api/comprobantes/${id}/xml`;
        } else {
            contenido.innerHTML = '<p class="text-danger">Error al cargar el comprobante</p>';
        }
    } catch (error) {
        contenido.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
    }
}

function cerrarModalVer() {
    document.getElementById('modal-ver').classList.remove('active');
}

// Cerrar modal con Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') cerrarModalVer();
});


// TEST: Verificar que el modal existe
console.log('Modal element:', document.getElementById('modal-ver'));
console.log('Modal content:', document.getElementById('modal-ver-contenido'));

</script>

{% endblock %}